"use strict";var qrpc=(()=>{var E=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var Z=Object.getOwnPropertyNames;var ee=Object.prototype.hasOwnProperty;var j=h=>{throw TypeError(h)};var te=(h,e,s)=>e in h?E(h,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):h[e]=s;var se=(h,e)=>{for(var s in e)E(h,s,{get:e[s],enumerable:!0})},ie=(h,e,s,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Z(e))!ee.call(h,i)&&i!==s&&E(h,i,{get:()=>e[i],enumerable:!(t=z(e,i))||t.enumerable});return h};var ne=h=>ie(E({},"__esModule",{value:!0}),h);var o=(h,e,s)=>te(h,typeof e!="symbol"?e+"":e,s),re=(h,e,s)=>e.has(h)||j("Cannot "+s);var B=(h,e,s)=>e.has(h)?j("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(h):e.set(h,s);var d=(h,e,s)=>(re(h,e,"access private method"),s);var oe={};se(oe,{QRPCMedia:()=>C,QRPCTrack:()=>m,QRPClient:()=>_});function R(h){return h instanceof Promise?h:h?Promise.resolve(h):Promise.resolve(void 0)}var m=class{constructor(e,s,t,i,r,n){o(this,"path");o(this,"media");o(this,"stream");o(this,"track");o(this,"encodings");o(this,"onopen");o(this,"onclose");o(this,"onpause");o(this,"onresume");o(this,"onupdate");o(this,"opened",!1);o(this,"pausedReasons",[]);o(this,"transceiver",null);o(this,"ssrc");this.path=e,this.media=s,this.media.addTrack(this),this.stream=t,this.track=i,this.encodings=r,this.onopen=n.onopen,this.onclose=n.onclose,this.onpause=n.onpause||(()=>{}),this.onresume=n.onresume||(()=>{}),this.onupdate=n.onupdate||(()=>{})}static path(e,s){return e+s}get id(){return this.track?.id||""}get kind(){let e=this.path.split("/");return e[e.length-1]}get raw(){return this.track}get cname(){let e=this.path.split("/");if(!this.isReceiver)throw new Error("cname is only for receiver track");return e[0]}get directory(){return this.path.split("/").slice(0,-1).join("/")}get mid(){return this.transceiver?.mid||null}get active(){return this.track!=null}get paused(){return this.pausedReasons.length>0}get direction(){return this.media.direction}get isReceiver(){return this.media.isReceiver}pausedBy(e){return this.pausedReasons.indexOf(e)>=0}pause(e,s){return this.pausedReasons.indexOf(e)<0&&this.pausedReasons.push(e),R(!s&&this.onpause&&this.onpause(this,e))}resume(e,s){let t=this.pausedReasons.indexOf(e);return t>=0?(this.pausedReasons.splice(t,1),R(!s&&this.onresume&&this.onresume(this,e))):Promise.resolve()}update(e){if(!this.transceiver)throw new Error("track is not started");return this.stream=e.stream,this.transceiver.sender.replaceTrack(e.track),this.track?.stop(),this.track=e.track,R(this.onupdate?.(this))}async open(e,s){if(this.direction!=="send"||this.track==null)throw new Error("open is only needed for send tracks");if(s){let t;for(let i of e.getTransceivers()){if(!i.sender){console.log("ignore receiver transceiver",i.sender);continue}let r=s[i.mid];if(!r){console.log("no path for mid:",i.mid,s);continue}if(r==this.path){t=i;break}}if(!t)throw new Error("no correspond transceiver:"+this.path);if(console.log("found transceiver for",this.path,t),t.direction="sendonly",this.kind==="video"){let i=t.sender.getParameters();await t.sender.setParameters(Object.assign(i,{encodings:this.encodings}))}await t.sender.replaceTrack(this.track),this.transceiver=t}else if(this.track.kind==="video")this.transceiver=e.addTransceiver(this.track,{direction:"sendonly",sendEncodings:this.encodings,streams:[this.stream]});else if(this.track.kind==="audio")this.transceiver=e.addTransceiver(this.track,{direction:"sendonly",streams:[this.stream]});else throw new Error(`invalid track kind ${this.track.kind}`)}async close(e,s){this.track&&(this.onclose?.(this),(s||!this.isReceiver)&&(this.transceiver?.mid&&e.removeTrack(this.transceiver.sender),this.track.stop()),this.track=null,this.transceiver=null,this.stream=null,this.opened=!1,this.pausedReasons=[]),this.media.removeTrack(this)}};o(m,"DEFAULT_TRACK_RECONNECTION_WAIT_MS",5e3),o(m,"PAUSE_REASON",{remote_close:"remote_close",local_op:"local_op",remote_op:"remote_op"});var C=class{constructor(e,s,t){o(this,"path");o(this,"direction");o(this,"initOptions");o(this,"tracks",{});o(this,"nextReconnect",0);o(this,"lastPing");o(this,"reconnectIntervalMS",null);o(this,"opened",!0);this.path=e,this.direction=s,this.initOptions=t||{},this.lastPing=new Date().getTime(),this.keepAlive()}get isReceiver(){return this.direction==="recv"}keepAlive(){this.lastPing=new Date().getTime()}addTrack(e){this.tracks[e.path]=e}removeTrack(e){delete this.tracks[e.path]}async pause(e){let s=[];for(let t in this.tracks){let i=await this.tracks[t].pause(e);if(e===m.PAUSE_REASON.remote_close){let r=null;i?typeof i=="number"&&(r=i):r=m.DEFAULT_TRACK_RECONNECTION_WAIT_MS,r&&s.push(r)}}if(s.length>0)return s.sort()[0]}resume(e){for(let s in this.tracks)this.tracks[s].resume(e)}startReconnect(e,s){this.reconnectIntervalMS=s,this.nextReconnect=new Date().getTime()+this.reconnectIntervalMS,this.reconnect(e)}stopReconnect(){this.reconnectIntervalMS=null,this.nextReconnect=0}async reconnect(e){try{console.log(`try reconnect for ${this.path}`),await e.watchMedia(this.path,{onopen:()=>{},onclose:()=>{},initOptions:Object.assign(this.initOptions,{sync:!0})})}catch(s){console.log(`reconnect failed for ${this.path}`,s)}}};var a,G,W,$,J,Y,v,T,I,F,V,N,ae,b,q,K,O,D,L,X,H,U,g=class g{constructor(e,s){B(this,a);o(this,"url");o(this,"cname");o(this,"cert",null);o(this,"reconnect",0);o(this,"id",null);o(this,"context",null);o(this,"pc",null);o(this,"syscall_ready",!1);o(this,"sentTracks",[]);o(this,"midMediaPathMap",{});o(this,"rpcPromises",{});o(this,"sdpGen",0);o(this,"msgidSeed",1);o(this,"syscallStream",null);o(this,"timer",null);o(this,"sdpQueue",[]);o(this,"streams",{});o(this,"medias",{});o(this,"tracks",{});o(this,"iceUsername",null);o(this,"icePassword",null);o(this,"candidates",[]);o(this,"endOfcandidates",!1);o(this,"onopen");o(this,"onclose");o(this,"onstream");this.url=e,this.cname=s||d(this,a,W).call(this),console.log("QRPClient",this.cname,e),d(this,a,$).call(this)}initIce(){this.iceUsername=null,this.icePassword=null,this.candidates=[],this.endOfcandidates=!1}get connected(){return this.pc?.connectionState==="connected"}async connect(){if(this.pc){console.log("Already connected");return}let e=await d(this,a,I).call(this);this.pc=e,this.initIce(),d(this,a,F).call(this,e),await d(this,a,K).call(this)}parseLocalOffer(e){let s={},t,i={},r=e.split(/\r?\n/);r.push("m=dummy");for(let n of r)if(n.startsWith("m="))t=void 0,i={};else if(n.startsWith("a=mid:"))if(!t)t=n.slice(6).trim(),s[t]=i;else throw new Error(`invalid find a=mid line twice before reset by m= line ${t},${n.slice(6)}`);else if(n.startsWith("a=ssrc:")){let c=n.slice(7).split(/\s/,2),l=c[0].trim(),p=c[1].split(/:/,1)[0].trim();i[l]||(i[l]=[]),i[l].push(p),t&&(s[t]=i)}return Object.fromEntries(Object.entries(s).filter(n=>Object.keys(n[1]).length==1).map(n=>[n[0],Object.keys(n[1])[0]]))}async close(){await d(this,a,O).call(this,!0)}async openMedia(e,s){let{stream:t,encodings:i,onopen:r,onclose:n,onupdate:c,onpause:l,onresume:p,initOptions:k}=s,M=d(this,a,D).call(this,e);if(console.log("openMedia",M,t,i),!i)throw new Error("encodings is mandatory");if(i.length>3)throw new Error("encodings more than 3 may not be treated correctly");let S={},y=0;i.forEach(u=>{if(!u.maxBitrate)throw new Error("for each encodings, maxBitrate is mandatory");if(u.rid)throw new Error("cannot specify rid for encodings");u.rid=`r${y++}`,u.scalabilityMode=u.scalabilityMode||g.DEFAULT_SCALABILITY_MODE,S[u.rid]=u.scalabilityMode}),i.sort((u,P)=>u.maxBitrate-P.maxBitrate);let f=[];if(t.getTracks().forEach(u=>{let P=m.path(M,u.kind),A=d(this,a,L).call(this,M,"send",k),w=new m(P,A,t,u,i,{onopen:r,onclose:n,onupdate:c,onpause:l,onresume:p});this.tracks[w.path]=w,this.sentTracks.push(w),f.push(w)}),d(this,a,v).call(this)){let{localOffer:u,midPathMap:P}=await d(this,a,N).call(this,f);console.log("openMedia: local offer",u.sdp,P);let A=d(this,a,T).call(this),w=[...this.sentTracks];try{let Q=await this.syscall("produce",{sdp:u.sdp,initOptions:k,midPathMap:P,rtp:{ridScalabilityModeMap:S}});await d(this,a,b).call(this,Q,A,w)}catch(Q){console.log(`openMedia: remote negotiation failed: ${Q}`);for(let x of f)delete this.medias[x.media.path],delete this.tracks[x.path],await x.close(this.pc);throw Q}}return f}async watchMedia(e,s){let{onopen:t,onclose:i,onpause:r,onresume:n,initOptions:c}=s;if(!d(this,a,v).call(this))throw new Error("watchMedia can only be called after handshake");let{cpath:l,kind:p}=d(this,a,X).call(this,e),k=[];for(let y of p?[p]:["video","audio"]){let f=p?l:m.path(l,y),u=d(this,a,L).call(this,l,"recv",c),P=this.tracks[f];if(!P){if(c?.sync)throw new Error(`no track for ${f} yet but sync option is set`);P=new m(f,u,null,null,[],{onopen:t,onclose:i,onpause:r,onresume:n}),this.tracks[f]=P}k.push(P)}let M=d(this,a,T).call(this),S=[...this.sentTracks];try{let y=await this.syscall("consume",{path:l,initOptions:c});await d(this,a,b).call(this,y,M,S)}catch(y){console.log("watchMedia: remote negotiation failed",y);for(let f of k)delete this.medias[f.media.path],delete this.tracks[f.path],await f.close(this.pc);throw y}return k}async pauseMedia(e){let s=this.tracks[e];if(s)await this.syscall("pause",{path:e}),s.pause(m.PAUSE_REASON.local_op);else throw new Error("pauseMedia: no media for "+e)}async resumeMedia(e){let s=this.tracks[e];if(s)await this.syscall("resume",{path:e}),s.resume(m.PAUSE_REASON.local_op);else throw new Error("resumeMedia: no media for "+e)}async updateMedia(e,s){let{stream:t}=s,i=d(this,a,D).call(this,e);if(!this.medias[i])throw new Error("updateMedia: no media for "+i);let n=[];return t.getTracks().forEach(c=>{let l=m.path(i,c.kind),p=this.tracks[l];p?(p.update({stream:t,track:c}),n.push(p)):console.log(`no track for ${e}`)}),n}async closeMedia(e){let s=await this.syscall("close_media",{path:e}),t=d(this,a,T).call(this),i=[...this.sentTracks];await d(this,a,b).call(this,s,t,i)}openStream(e,s){if(this.streams[e])return this.streams[e];let t=this.pc.createDataChannel(e,s);return d(this,a,U).call(this,t,s),t}closeStream(e){let s=this.streams[e];if(!s){console.log(`No stream for path ${e}`);return}s.close(),delete this.streams[e]}watchStream(e,s){return this.openStream(`$watch/${e}`,s)}async syscall(e,s){return new Promise((t,i)=>{let r=d(this,a,J).call(this);this.syscallStream.send(JSON.stringify({fn:e,args:s,msgid:r})),this.rpcPromises[r]={resolve:t,reject:i}})}};a=new WeakSet,G=async function(e,s){let t=JSON.parse(s.data);if(g.VERBOSE_SYSCALL.indexOf(t.fn)<0&&console.log("syscall",t),!t.msgid){if(t.fn==="close")console.log("shutdown by server"),d(this,a,O).call(this);else if(t.fn==="close_track")console.log("close_track",t.args.path),await d(this,a,H).call(this,[t.args.path]);else if(t.fn=="remote_pause"||t.fn=="remote_resume"){let r=this.tracks[t.args.path];if(r)t.fn=="remote_pause"?r.pause(m.PAUSE_REASON.remote_op):r.resume(m.PAUSE_REASON.remote_op);else throw new Error(`no such track for ${t.fn}: ${t.args.path}`)}else if(t.fn=="ping"){if(t.args.path){let r=this.tracks[t.args.path];r&&r.media&&r.media.keepAlive()}}else throw new Error("unknown syscall: "+JSON.stringify(t));return}let i=d(this,a,Y).call(this,t.msgid);if(!i){console.log("no promise for msgid",t.msgid);return}if(t.args&&t.args.error){i.reject(new Error(t.args.error));return}if(t.fn=="consume")throw new Error("currently, publish to other peer is not suported");if(t.fn=="consume_ack"){if(!t.args.sdp){i.reject(new Error(`invalid response: no sdp: ${JSON.stringify(t.args)}`));return}for(let r in t.args.status_map||{}){let n=t.args.status_map[r],c=this.tracks[r];if(c)for(let l of n.pausedReasons||[])c.pause(l,!0);else console.log(`no such track for [${r}]`,this.tracks,this.tracks[r])}Object.assign(this.midMediaPathMap,t.args.mid_media_path_map||{}),console.log("midMediaPathMap => ",this.midMediaPathMap),i.resolve(t.args.sdp)}else{if(t.fn=="produce")throw new Error("currently, publish to other peer is not suported");if(t.fn=="produce_ack"){if(!t.args.sdp){i.reject(new Error(`invalid response: no sdp: ${JSON.stringify(t.args)}`));return}Object.assign(this.midMediaPathMap,t.args.mid_media_path_map||{}),console.log("midMediaPathMap => ",this.midMediaPathMap);for(let r in t.args.status_map||{}){let n=t.args.status_map[r],c=this.tracks[r];if(c)for(let l of n.pausedReasons||[])c.pause(l,!0)}i.resolve(t.args.sdp)}else t.fn=="close_media_ack"?(await d(this,a,H).call(this,t.args.paths),i.resolve(t.args.sdp)):t.fn=="resume_ack"||t.fn=="pause_ack"||t.fn=="close_ack"||t.fn=="sync_ack"||t.fn=="ping_ack"||t.fn=="publish_stream_ack"||t.fn=="remote_answer_ack"?i.resolve():console.log("unknown syscall",t)}},W=function(){let e=new Uint8Array(8);return crypto.getRandomValues(e),btoa(String.fromCharCode(...e)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")},$=function(){this.streams={},this.medias={},this.tracks={},this.syscall_ready=!1,this.sentTracks=[],this.midMediaPathMap={},this.rpcPromises={},this.sdpGen=0,this.msgidSeed=1,this.id=null,this.syscallStream=null,this.timer=null,this.sdpQueue=[]},J=function(){return this.msgidSeed>=g.MAX_MSGID&&(this.msgidSeed=1),this.msgidSeed++},Y=function(e){let s=this.rpcPromises[e];return s&&delete this.rpcPromises[e],s},v=function(){return this.syscall_ready&&this.pc!==null&&this.pc.connectionState!=="failed"},T=function(){return++this.sdpGen},I=async function(){return this.cert||(this.cert=await RTCPeerConnection.generateCertificate({name:"ECDSA",namedCurve:"P-256"})),new RTCPeerConnection({iceServers:[],certificates:[this.cert]})},F=function(e){e.ondatachannel=s=>{let t=s.channel,i=t.label;if(console.log(`accept stream ${i}`),!this.onstream)throw t.close(),new Error("QRPClient.onstream is mandatory");let r=this.onstream(t);if(!r){console.log(`No stream callbacks for path [${i}]`),t.close();return}d(this,a,U).call(this,t,r)},e.ontrack=async s=>{console.log("ontrack",s);let t=s.track,i=t.id,r=s.receiver,n;if(s.transceiver){if(s.transceiver.mid==="probator")return;if(!s.transceiver.mid)throw new Error(`transceiver has no mid: ${s.transceiver}`);if(n=this.midMediaPathMap[s.transceiver.mid],!n)throw new Error(`No path is defined for mid = ${s.transceiver.mid}`)}else throw new Error("event has no transceiver");let c=this.tracks[n];if(!c){console.log(`No media for path ${n}`),t.stop();return}if(c.direction==="recv"&&(c.track=t,c.transceiver=s.transceiver,c.stream=s.streams[0]),!c.opened){if(c.onopen){let l=await Promise.resolve(c.onopen(c));if(l===!1||l===null){console.log(`close media by application ${n}`),this.closeMedia(n);return}}c.opened=!0}},e.oniceconnectionstatechange=s=>{console.log("ICE connection state change",e.iceConnectionState)},e.onconnectionstatechange=async s=>{switch(console.log("Connection state change",e.connectionState),e.connectionState){case"connected":break;case"disconnected":case"failed":await d(this,a,O).call(this);break;case"closed":break}},e.onicecandidate=s=>{if(s.candidate){if((s.candidate.sdpMLineIndex||0)>0)return;this.candidates.push(s.candidate)}else this.endOfcandidates=!0},this.timer=setInterval(async()=>{let s=new Date().getTime();await d(this,a,V).call(this,s)},1e3)},V=async function(e){let s=!1;for(let t in this.medias){let i=this.medias[t];if(i.isReceiver)if(e-i.lastPing>g.NO_INPUT_THRESHOLD*1e3)if(i.opened){i.opened=!1;let r=await i.pause(m.PAUSE_REASON.remote_close);console.log(`no ping for ${i.path} for ${g.NO_INPUT_THRESHOLD*1e3} ms`,r),r&&(i.startReconnect(this,r),console.log(`track ${i.path} will try reconnect every ${r} ms`))}else i.reconnectIntervalMS&&e>i.nextReconnect&&(i.reconnect(this),i.nextReconnect=e+i.reconnectIntervalMS);else i.opened||(console.log(`input again for ${i.path}`),i.opened=!0,i.stopReconnect(),i.resume(m.PAUSE_REASON.remote_close));else i.opened&&(s=!0)}s&&this.syscall("ping",{})},N=async function(e){let s={},t=await d(this,a,I).call(this);t.createDataChannel("dummy");for(let n of e)await n.open(t);let i=await t.createOffer();await t.setLocalDescription(i);let r=this.parseLocalOffer(i.sdp);for(let n of e)s[n.mid]=n.path,n.ssrc=r[n.mid]||void 0;return t.close(),{localOffer:i,midPathMap:s}},ae=function(e,s){let t=[],i=[],r=e.split(/\r?\n/);r.push("m=dummy");let n;for(let l of r){if(l.startsWith("m=")){if(n){if(i.length<=0)throw new Error(`should have chunk for ${n}`);t.push({mid:n,chunk:i})}else{if(t.length>0)throw new Error("only first chunk allowed without mid");t.push({mid:null,chunk:i})}i=[l],n=void 0;continue}if(i.push(l),l.startsWith("a=mid:"))if(!n)n=l.slice(6);else throw new Error(`invalid find a=mid line twice before reset by m= line ${n},${l}`)}let c=[];for(let l of t){let p=l.mid!==null?s[l.mid]:null;if(p){let k=l.chunk.join(`
`);c.push(k.replace(/a=ssrc:[0-9]+/g,`a=ssrc:${p}`))}else c.push(l.chunk.join(`
`))}return c.join(`
`)},b=async function(e,s,t){if(console.log("remote offer sdp",e,s),this.pc==null)throw new Error("peer connection is not initialized");for(let n of this.sdpQueue)if(n.sdpGen>s){console.log(`skip sdpGen=${s} because newer generation exists: ${n.sdpGen}`);return}if(this.sdpQueue.push({remoteOffer:e,sdpGen:s,sentTracks:t}),this.sdpQueue.length>1){console.log(`queue sdpGen=${s}`,this.sdpQueue);return}await this.pc.setRemoteDescription({type:"offer",sdp:e});let i={};for(let n of t)await n.open(this.pc,this.midMediaPathMap),n.ssrc&&(i[n.mid]=n.ssrc);let r=await this.pc.createAnswer();if(d(this,a,v).call(this)){let n=this.parseLocalOffer(r.sdp);console.log("midSsrcMaps",i,n),await this.syscall("remote_answer",{midMap:Object.fromEntries(Object.keys(i).map(c=>[c,{ssrc_fixups:[[Number(i[c]),Number(n[c])]]}]))});for(let c of t)c.ssrc=n[c.mid]||void 0}if(await this.pc.setLocalDescription(r),console.log(`apply sdpGen=${s} is finished`),this.sdpQueue.length>1){await new Promise(c=>setTimeout(c,1e3));let n=this.sdpQueue[this.sdpQueue.length-1];this.sdpQueue=[],await d(this,a,b).call(this,n.remoteOffer,n.sdpGen,n.sentTracks)}else this.sdpQueue=[]},q=async function(){let e=new RTCPeerConnection;return e.addTransceiver("audio"),e.addTransceiver("video"),(await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})).sdp},K=async function(){if(d(this,a,v).call(this))throw new Error("handshake only called once in a session");let e=new Promise((c,l)=>{this.syscallStream=this.openStream(g.SYSCALL_STREAM,{onmessage:d(this,a,G).bind(this),onopen:(p,k)=>c(k),onerror:(p,k)=>l(k)})}),s=d(this,a,T).call(this),t=[...this.sentTracks],{localOffer:i}=await d(this,a,N).call(this,t);console.log("local offer sdp",i.sdp),this.iceUsername=i.sdp.match(/a=ice-ufrag:(.*)[\r\n]+/)[1],this.icePassword=i.sdp.match(/a=ice-pwd:(.*)[\r\n]+/)[1];let r=await fetch(this.url,{method:"POST",body:JSON.stringify({sdp:i.sdp,cname:this.cname,capability:await d(this,a,q).call(this)}),headers:{"Content-Type":"application/json"}});if(!r.ok)throw new Error(`Request rejected with status ${r.status}`);let n;try{n=await r.text();let{sdp:c,mid_media_path_map:l}=JSON.parse(n);for(let p in l||{})this.midMediaPathMap[p]=l[p];console.log("midMediaPathMap =>",this.midMediaPathMap),this.id=c.match(/a=ice-ufrag:(.*)[\r\n]+/)[1],console.log("id",this.id),await d(this,a,b).call(this,c,s,t),await e,this.syscall_ready=!0,this.onopen&&(this.context=await this.onopen())}catch(c){throw console.log(`error in handling whip response: ${c}|${n||"no response"}`),c}},O=async function(e){if(!this.pc)return;e&&await this.syscall("close",{});let s;this.onclose?(s=this.onclose(),s?s=s/1e3/1e3:s=0):s=5e3;for(let t in this.tracks)console.log("close track",t),await this.tracks[t].close(this.pc,!0);for(let t in this.streams)console.log("close stream",t),this.streams[t].close();this.timer&&clearInterval(this.timer),this.pc.connectionState!="failed"&&this.pc.close(),this.pc=null,d(this,a,$).call(this),s>0?(console.log(`attempt reconnect after ${s} ms`),setTimeout(()=>{this.reconnect++,this.connect()},s)):console.log("no reconnect. bye!")},D=function(e){let s=e.split("/");if(s.length==1)return e+"/";if(s[s.length-1].length>0)throw new Error(`invalid path: ${e}: should be ended with /`);return e},L=function(e,s,t){let i=e.split("/"),r;return(i[i.length-1]==="video"||i[i.length-1]==="audio")&&(e=e.slice(0,-5)),this.medias[e]?r=this.medias[e]:(r=new C(e,s,t),this.medias[e]=r),r},X=function(e){let s=e.split("/");if(s.length<2)throw new Error(`invalid path: ${e}: at least \${cname}/\${single_component_local_path} required`);if(s.length==2){let t=s[s.length-1];if(t==="audio"||t==="video")throw new Error(`invalid path: ${e}: has single component local_path but the component seems to be media kind`);return{cpath:e+"/",kind:void 0}}else{let t=s[s.length-1];return t.length>0?t!=="audio"&&t!=="video"?{cpath:e+"/",kind:void 0}:{cpath:e,kind:t}:{cpath:e,kind:void 0}}},H=async function(e){let s={};for(let t of e){let i=this.tracks[t];i&&(s[i.media.path]=i.media,await i.close(this.pc),delete this.tracks[t]);let r=this.sentTracks.indexOf(i);r>=0&&this.sentTracks.splice(r,1)}for(let t in s){let i=s[t];Object.keys(i.tracks).length===0&&(console.log("close media",i.path),delete this.medias[i.path])}},U=function(e,s){let t=e.label,{onopen:i,onclose:r,onmessage:n,onerror:c}=s;e.onopen=i&&(async l=>{s.publish&&await this.syscall("publish_stream",{path:t});let p=await R(i(e,l));if(p===!1||p===null){console.log(`close stream by application path=${t}`),this.closeStream(t);return}else e.context=p})||(async l=>{s.publish&&await this.syscall("publish_stream",{path:t})}),e.onclose=r&&(l=>{r(e,l),delete this.streams[t]})||(l=>{delete this.streams[t]}),e.onerror=c&&(l=>{c(e,l),delete this.streams[t]})||(l=>{delete this.streams[t]}),e.onmessage=l=>n(e,l),this.streams[t]=e},o(g,"SYSCALL_STREAM","$syscall"),o(g,"DEFAULT_SCALABILITY_MODE","L1T3"),o(g,"NO_INPUT_THRESHOLD",3),o(g,"VERBOSE_SYSCALL",["ping","ping_ack"]),o(g,"MAX_MSGID",Number.MAX_SAFE_INTEGER);var _=g;return ne(oe);})();
if (typeof window !== "undefined") { window.QRPClient = qrpc.QRPClient || qrpc.default;window.QRPCTrack = qrpc.QRPCTrack || qrpc.default;window.QRPCMedia = qrpc.QRPCMedia || qrpc.default}
//# sourceMappingURL=qrpc.bundle.js.map
