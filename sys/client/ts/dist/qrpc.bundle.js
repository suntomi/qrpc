"use strict";var QRPC=(()=>{var Q=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var Z=Object.getOwnPropertyNames;var ee=Object.prototype.hasOwnProperty;var U=h=>{throw TypeError(h)};var te=(h,e,s)=>e in h?Q(h,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):h[e]=s;var se=(h,e)=>{for(var s in e)Q(h,s,{get:e[s],enumerable:!0})},ie=(h,e,s,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Z(e))!ee.call(h,i)&&i!==s&&Q(h,i,{get:()=>e[i],enumerable:!(t=z(e,i))||t.enumerable});return h};var ne=h=>ie(Q({},"__esModule",{value:!0}),h);var o=(h,e,s)=>te(h,typeof e!="symbol"?e+"":e,s),re=(h,e,s)=>e.has(h)||U("Cannot "+s);var B=(h,e,s)=>e.has(h)?U("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(h):e.set(h,s);var l=(h,e,s)=>(re(h,e,"access private method"),s);var oe={};se(oe,{QRPCMedia:()=>R,QRPCTrack:()=>m,QRPClient:()=>_});function E(h){return h instanceof Promise?h:Promise.resolve(h)}var m=class{constructor(e,s,t,i,n,r){o(this,"path");o(this,"media");o(this,"stream");o(this,"track");o(this,"encodings");o(this,"onopen");o(this,"onclose");o(this,"onpause");o(this,"onresume");o(this,"onupdate");o(this,"opened",!1);o(this,"pausedReasons",[]);o(this,"transceiver",null);o(this,"ssrc");this.path=e,this.media=s,this.media.addTrack(this),this.stream=t,this.track=i,this.encodings=n,this.onopen=r.onopen,this.onclose=r.onclose,this.onpause=r.onpause||(()=>{}),this.onresume=r.onresume||(()=>{}),this.onupdate=r.onupdate||(()=>{})}static path(e,s){return e+s}get id(){return this.track?.id||""}get kind(){let e=this.path.split("/");return e[e.length-1]}get raw(){return this.track}get cname(){let e=this.path.split("/");if(!this.isReceiver)throw new Error("cname is only for receiver track");return e[0]}get directory(){return this.path.split("/").slice(0,-1).join("/")}get mid(){return this.transceiver?.mid||null}get active(){return this.track!=null}get paused(){return this.pausedReasons.length>0}get direction(){return this.media.direction}get isReceiver(){return this.media.isReceiver}pausedBy(e){return this.pausedReasons.indexOf(e)>=0}pause(e,s){return this.pausedReasons.indexOf(e)<0&&this.pausedReasons.push(e),E(!s&&this.onpause&&this.onpause(this,e))}resume(e,s){let t=this.pausedReasons.indexOf(e);return t>=0?(this.pausedReasons.splice(t,1),E(!s&&this.onresume&&this.onresume(this,e))):Promise.resolve()}update(e){if(!this.transceiver)throw new Error("track is not started");return this.stream=e.stream,this.transceiver.sender.replaceTrack(e.track),this.track?.stop(),this.track=e.track,E(this.onupdate?.(this))}async open(e,s){if(this.direction!=="send"||this.track==null)throw new Error("open is only needed for send tracks");if(s){let t;for(let i of e.getTransceivers()){if(!i.sender){console.log("ignore receiver transceiver",i.sender);continue}let n=s[i.mid];if(!n){console.log("no path for mid:",i.mid,s);continue}if(n==this.path){t=i;break}}if(!t)throw new Error("no correspond transceiver:"+this.path);if(console.log("found transceiver for",this.path,t),t.direction="sendonly",this.kind==="video"){let i=t.sender.getParameters();await t.sender.setParameters(Object.assign(i,{encodings:this.encodings}))}await t.sender.replaceTrack(this.track),this.transceiver=t}else if(this.track.kind==="video")this.transceiver=e.addTransceiver(this.track,{direction:"sendonly",sendEncodings:this.encodings,streams:[this.stream]});else if(this.track.kind==="audio")this.transceiver=e.addTransceiver(this.track,{direction:"sendonly",streams:[this.stream]});else throw new Error(`invalid track kind ${this.track.kind}`)}async close(e,s){this.track&&(this.onclose?.(this),(s||!this.isReceiver)&&(this.transceiver?.mid&&e.removeTrack(this.transceiver.sender),this.track.stop()),this.track=null,this.transceiver=null,this.stream=null,this.opened=!1,this.pausedReasons=[]),this.media.removeTrack(this)}};o(m,"DEFAULT_TRACK_RECONNECTION_WAIT_MS",5e3),o(m,"PAUSE_REASON",{remote_close:"remote_close",local_op:"local_op",remote_op:"remote_op"});var R=class{constructor(e,s,t){o(this,"path");o(this,"direction");o(this,"initOptions");o(this,"tracks",{});o(this,"nextReconnect",0);o(this,"lastPing");o(this,"reconnectIntervalMS",null);o(this,"opened",!0);this.path=e,this.direction=s,this.initOptions=t||{},this.lastPing=new Date().getTime(),this.keepAlive()}get isReceiver(){return this.direction==="recv"}keepAlive(){this.lastPing=new Date().getTime()}addTrack(e){this.tracks[e.path]=e}removeTrack(e){delete this.tracks[e.path]}pause(e){let s=[];for(let t in this.tracks){let i=this.tracks[t].pause(e);if(e===m.PAUSE_REASON.remote_close){let n=null;!i&&i!==!1&&i!==null?n=m.DEFAULT_TRACK_RECONNECTION_WAIT_MS:typeof i=="number"&&(n=i),n&&s.push(n)}}if(s.length>0)return s.sort()[0]}resume(e){for(let s in this.tracks)this.tracks[s].resume(e)}startReconnect(e,s){this.reconnectIntervalMS=s,this.nextReconnect=new Date().getTime()+this.reconnectIntervalMS,this.reconnect(e)}stopReconnect(){this.reconnectIntervalMS=null,this.nextReconnect=0}async reconnect(e){try{console.log(`try reconnect for ${this.path}`),await e.watchMedia(this.path,{onopen:()=>{},onclose:()=>{},initOptions:Object.assign(this.initOptions,{sync:!0})})}catch(s){console.log(`reconnect failed for ${this.path}`,s)}}};var a,G,W,$,J,Y,M,v,I,F,V,D,ae,b,q,K,O,N,H,X,L,j,g=class g{constructor(e,s){B(this,a);o(this,"url");o(this,"cname");o(this,"cert",null);o(this,"reconnect",0);o(this,"id",null);o(this,"context",null);o(this,"pc",null);o(this,"syscall_ready",!1);o(this,"sentTracks",[]);o(this,"midMediaPathMap",{});o(this,"rpcPromises",{});o(this,"sdpGen",0);o(this,"msgidSeed",1);o(this,"syscallStream",null);o(this,"timer",null);o(this,"sdpQueue",[]);o(this,"streams",{});o(this,"medias",{});o(this,"tracks",{});o(this,"iceUsername",null);o(this,"icePassword",null);o(this,"candidates",[]);o(this,"endOfcandidates",!1);o(this,"onopen");o(this,"onclose");o(this,"onstream");this.url=e,this.cname=s||l(this,a,W).call(this),console.log("QRPClient",this.cname,e),l(this,a,$).call(this)}initIce(){this.iceUsername=null,this.icePassword=null,this.candidates=[],this.endOfcandidates=!1}get connected(){return this.pc?.connectionState==="connected"}async connect(){if(this.pc){console.log("Already connected");return}let e=await l(this,a,I).call(this);this.pc=e,this.initIce(),l(this,a,F).call(this,e),await l(this,a,K).call(this)}parseLocalOffer(e){let s={},t,i={},n=e.split(/\r?\n/);n.push("m=dummy");for(let r of n)if(r.startsWith("m="))t=void 0,i={};else if(r.startsWith("a=mid:"))if(!t)t=r.slice(6).trim(),s[t]=i;else throw new Error(`invalid find a=mid line twice before reset by m= line ${t},${r.slice(6)}`);else if(r.startsWith("a=ssrc:")){let c=r.slice(7).split(/\s/,2),d=c[0].trim(),p=c[1].split(/:/,1)[0].trim();console.log("ssrc/attrName",d,p),i[d]||(i[d]=[]),i[d].push(p),t&&(s[t]=i)}return Object.fromEntries(Object.entries(s).filter(r=>Object.keys(r[1]).length==1).map(r=>[r[0],Object.keys(r[1])[0]]))}async close(){await l(this,a,O).call(this,!0)}async openMedia(e,s){let{stream:t,encodings:i,onopen:n,onclose:r,onupdate:c,onpause:d,onresume:p,initOptions:k}=s,C=l(this,a,N).call(this,e);if(console.log("openMedia",C,t,i),!i)throw new Error("encodings is mandatory");if(i.length>3)throw new Error("encodings more than 3 may not be treated correctly");let T={},y=0;i.forEach(u=>{if(!u.maxBitrate)throw new Error("for each encodings, maxBitrate is mandatory");if(u.rid)throw new Error("cannot specify rid for encodings");u.rid=`r${y++}`,u.scalabilityMode=u.scalabilityMode||g.DEFAULT_SCALABILITY_MODE,T[u.rid]=u.scalabilityMode}),i.sort((u,P)=>u.maxBitrate-P.maxBitrate);let f=[];if(t.getTracks().forEach(u=>{let P=m.path(C,u.kind),A=l(this,a,H).call(this,C,"send",k),w=new m(P,A,t,u,i,{onopen:n,onclose:r,onupdate:c,onpause:d,onresume:p});this.tracks[w.path]=w,this.sentTracks.push(w),f.push(w)}),l(this,a,M).call(this)){let{localOffer:u,midPathMap:P}=await l(this,a,D).call(this,f);console.log("openMedia: local offer",u.sdp,P);let A=l(this,a,v).call(this),w=[...this.sentTracks];try{let S=await this.syscall("produce",{sdp:u.sdp,initOptions:k,midPathMap:P,rtp:{ridScalabilityModeMap:T}});await l(this,a,b).call(this,S,A,w)}catch(S){console.log(`openMedia: remote negotiation failed: ${S}`);for(let x of f)delete this.medias[x.media.path],delete this.tracks[x.path],await x.close(this.pc);throw S}}return f}async watchMedia(e,s){let{onopen:t,onclose:i,onpause:n,onresume:r,initOptions:c}=s;if(!l(this,a,M).call(this))throw new Error("watchMedia can only be called after handshake");let{cpath:d,kind:p}=l(this,a,X).call(this,e),k=[];for(let y of p?[p]:["video","audio"]){let f=p?d:m.path(d,y),u=l(this,a,H).call(this,d,"recv",c),P=this.tracks[f];if(!P){if(c?.sync)throw new Error(`no track for ${f} yet but sync option is set`);P=new m(f,u,null,null,[],{onopen:t,onclose:i,onpause:n,onresume:r}),this.tracks[f]=P}k.push(P)}let C=l(this,a,v).call(this),T=[...this.sentTracks];try{let y=await this.syscall("consume",{path:d,initOptions:c});await l(this,a,b).call(this,y,C,T)}catch(y){console.log("watchMedia: remote negotiation failed",y);for(let f of k)delete this.medias[f.media.path],delete this.tracks[f.path],await f.close(this.pc);throw y}return k}async pauseMedia(e){if(this.tracks[e])await this.syscall("pause",{path:e});else throw new Error("pauseMedia: no media for "+e)}async resumeMedia(e){if(this.tracks[e])await this.syscall("resume",{path:e});else throw new Error("resumeMedia: no media for "+e)}async updateMedia(e,s){let{stream:t}=s,i=l(this,a,N).call(this,e);if(!this.medias[i])throw new Error("updateMedia: no media for "+i);let r=[];return t.getTracks().forEach(c=>{let d=m.path(i,c.kind),p=this.tracks[d];p?(p.update({stream:t,track:c}),r.push(p)):console.log(`no track for ${e}`)}),r}async closeMedia(e){let s=await this.syscall("close_media",{path:e}),t=l(this,a,v).call(this),i=[...this.sentTracks];await l(this,a,b).call(this,s,t,i)}openStream(e,s){if(this.streams[e])throw new Error("stream already exists for path: "+e);let t=this.pc.createDataChannel(e,s);return l(this,a,j).call(this,t,s),t}closeStream(e){let s=this.streams[e];if(!s){console.log(`No stream for path ${e}`);return}s.close(),delete this.streams[e]}watchStream(e,s){throw new Error("watchStream not implemented yet")}async syscall(e,s){return new Promise((t,i)=>{let n=l(this,a,J).call(this);this.syscallStream.send(JSON.stringify({fn:e,args:s,msgid:n})),this.rpcPromises[n]={resolve:t,reject:i}})}};a=new WeakSet,G=async function(e,s){let t=JSON.parse(s.data);if(g.VERBOSE_SYSCALL.indexOf(t.fn)<0&&console.log("syscall",t),!t.msgid){if(t.fn==="close")console.log("shutdown by server"),l(this,a,O).call(this);else if(t.fn==="close_track")console.log("close_track",t.args.path),await l(this,a,L).call(this,[t.args.path]);else if(t.fn=="remote_pause"||t.fn=="remote_resume"){let n=this.tracks[t.args.path];if(n)t.fn=="remote_pause"?n.pause(m.PAUSE_REASON.remote_op):n.resume(m.PAUSE_REASON.remote_op);else throw new Error(`no such track for ${t.fn}: ${t.args.path}`)}else if(t.fn=="ping"){if(t.args.path){let n=this.tracks[t.args.path];n&&n.media&&n.media.keepAlive()}}else console.log("unhandled server syscall",t);return}let i=l(this,a,Y).call(this,t.msgid);if(!i){console.log("no promise for msgid",t.msgid);return}if(t.args&&t.args.error){i.reject(new Error(t.args.error));return}if(t.fn=="consume")throw new Error("currently, publish to other peer is not suported");if(t.fn=="consume_ack"){if(!t.args.sdp){i.reject(new Error(`invalid response: no sdp: ${JSON.stringify(t.args)}`));return}for(let n in t.args.status_map||{}){let r=t.args.status_map[n],c=this.tracks[n];if(c)for(let d of r.pausedReasons||[])c.pause(d,!0);else console.log(`no such track for [${n}]`,this.tracks,this.tracks[n])}Object.assign(this.midMediaPathMap,t.args.mid_media_path_map||{}),console.log("midMediaPathMap => ",this.midMediaPathMap),i.resolve(t.args.sdp)}else{if(t.fn=="produce")throw new Error("currently, publish to other peer is not suported");if(t.fn=="produce_ack"){if(!t.args.sdp){i.reject(new Error(`invalid response: no sdp: ${JSON.stringify(t.args)}`));return}Object.assign(this.midMediaPathMap,t.args.mid_media_path_map||{}),console.log("midMediaPathMap => ",this.midMediaPathMap);for(let n in t.args.status_map||{}){let r=t.args.status_map[n],c=this.tracks[n];if(c)for(let d of r.pausedReasons||[])c.pause(d,!0)}i.resolve(t.args.sdp)}else t.fn=="close_media_ack"?(await l(this,a,L).call(this,t.args.paths),i.resolve(t.args.sdp)):t.fn=="resume_ack"||t.fn=="pause_ack"||t.fn=="close_ack"||t.fn=="sync_ack"||t.fn=="ping_ack"||t.fn=="publish_stream_ack"||t.fn=="remote_answer_ack"?i.resolve():console.log("unknown syscall",t)}},W=function(){let e=new Uint8Array(8);return crypto.getRandomValues(e),btoa(String.fromCharCode(...e)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")},$=function(){this.streams={},this.medias={},this.tracks={},this.syscall_ready=!1,this.sentTracks=[],this.midMediaPathMap={},this.rpcPromises={},this.sdpGen=0,this.msgidSeed=1,this.id=null,this.syscallStream=null,this.timer=null,this.sdpQueue=[]},J=function(){return this.msgidSeed>=g.MAX_MSGID&&(this.msgidSeed=1),this.msgidSeed++},Y=function(e){let s=this.rpcPromises[e];return s&&delete this.rpcPromises[e],s},M=function(){return this.syscall_ready&&this.pc!==null&&this.pc.connectionState!=="failed"},v=function(){return++this.sdpGen},I=async function(){return this.cert||(this.cert=await RTCPeerConnection.generateCertificate({name:"ECDSA",namedCurve:"P-256"})),new RTCPeerConnection({iceServers:[],certificates:[this.cert]})},F=function(e){e.ondatachannel=s=>{let t=s.channel,i=t.label;if(console.log(`accept stream ${i}`),!this.onstream)throw t.close(),new Error("QRPClient.onstream is mandatory");let n=this.onstream(t);if(!n){console.log(`No stream callbacks for path [${i}]`),t.close();return}l(this,a,j).call(this,t,n)},e.ontrack=async s=>{console.log("ontrack",s);let t=s.track,i=t.id,n=s.receiver,r;if(s.transceiver){if(s.transceiver.mid==="probator")return;if(!s.transceiver.mid)throw new Error(`transceiver has no mid: ${s.transceiver}`);if(r=this.midMediaPathMap[s.transceiver.mid],!r)throw new Error(`No path is defined for mid = ${s.transceiver.mid}`)}else throw new Error("event has no transceiver");let c=this.tracks[r];if(!c){console.log(`No media for path ${r}`),t.stop();return}if(c.direction==="recv"&&(c.track=t,c.transceiver=s.transceiver,c.stream=s.streams[0]),!c.opened){if(c.onopen){let d=await Promise.resolve(c.onopen(c));if(d===!1||d===null){console.log(`close media by application ${r}`),this.closeMedia(r);return}}c.opened=!0}},e.oniceconnectionstatechange=s=>{console.log("ICE connection state change",e.iceConnectionState)},e.onconnectionstatechange=async s=>{switch(console.log("Connection state change",e.connectionState),e.connectionState){case"connected":break;case"disconnected":case"failed":await l(this,a,O).call(this);break;case"closed":break}},e.onicecandidate=s=>{if(s.candidate){if((s.candidate.sdpMLineIndex||0)>0)return;this.candidates.push(s.candidate)}else this.endOfcandidates=!0},this.timer=setInterval(()=>{let s=new Date().getTime();l(this,a,V).call(this,s)},1e3)},V=function(e){let s=!1;for(let t in this.medias){let i=this.medias[t];if(i.isReceiver)if(e-i.lastPing>g.NO_INPUT_THRESHOLD*1e3)if(i.opened){i.opened=!1;let n=i.pause(m.PAUSE_REASON.remote_close);console.log(`no ping for ${i.path} for ${g.NO_INPUT_THRESHOLD*1e3} ms`,n),n&&(i.startReconnect(this,n),console.log(`track ${i.path} will try reconnect every ${n} ms`))}else i.reconnectIntervalMS&&e>i.nextReconnect&&(i.reconnect(this),i.nextReconnect=e+i.reconnectIntervalMS);else i.opened||(console.log(`input again for ${i.path}`),i.opened=!0,i.stopReconnect(),i.resume(m.PAUSE_REASON.remote_close));else i.opened&&(s=!0)}s&&this.syscall("ping",{})},D=async function(e){let s={},t=await l(this,a,I).call(this);t.createDataChannel("dummy");for(let r of e)await r.open(t);let i=await t.createOffer();await t.setLocalDescription(i);let n=this.parseLocalOffer(i.sdp);for(let r of e)s[r.mid]=r.path,r.ssrc=n[r.mid]||void 0;return t.close(),{localOffer:i,midPathMap:s}},ae=function(e,s){let t=[],i=[],n=e.split(/\r?\n/);n.push("m=dummy");let r;for(let d of n){if(d.startsWith("m=")){if(r){if(i.length<=0)throw new Error(`should have chunk for ${r}`);t.push({mid:r,chunk:i})}else{if(t.length>0)throw new Error("only first chunk allowed without mid");t.push({mid:null,chunk:i})}i=[d],r=void 0;continue}if(i.push(d),d.startsWith("a=mid:"))if(!r)r=d.slice(6);else throw new Error(`invalid find a=mid line twice before reset by m= line ${r},${d}`)}let c=[];for(let d of t){let p=d.mid!==null?s[d.mid]:null;if(p){let k=d.chunk.join(`
`);c.push(k.replace(/a=ssrc:[0-9]+/g,`a=ssrc:${p}`))}else c.push(d.chunk.join(`
`))}return c.join(`
`)},b=async function(e,s,t){if(console.log("remote offer sdp",e,s),this.pc==null)throw new Error("peer connection is not initialized");for(let r of this.sdpQueue)if(r.sdpGen>s){console.log(`skip sdpGen=${s} because newer generation exists: ${r.sdpGen}`);return}if(this.sdpQueue.push({remoteOffer:e,sdpGen:s,sentTracks:t}),this.sdpQueue.length>1){console.log(`queue sdpGen=${s}`,this.sdpQueue);return}await this.pc.setRemoteDescription({type:"offer",sdp:e});let i={};for(let r of t)await r.open(this.pc,this.midMediaPathMap),r.ssrc&&(i[r.mid]=r.ssrc);let n=await this.pc.createAnswer();if(l(this,a,M).call(this)){let r=this.parseLocalOffer(n.sdp);console.log("midSsrcMaps",i,r),await this.syscall("remote_answer",{midMap:Object.fromEntries(Object.keys(i).map(c=>[c,{ssrc_fixups:[[Number(i[c]),Number(r[c])]]}]))});for(let c of t)c.ssrc=r[c.mid]||void 0}if(await this.pc.setLocalDescription(n),console.log(`apply sdpGen=${s} is finished`),this.sdpQueue.length>1){await new Promise(c=>setTimeout(c,1e3));let r=this.sdpQueue[this.sdpQueue.length-1];this.sdpQueue=[],await l(this,a,b).call(this,r.remoteOffer,r.sdpGen,r.sentTracks)}else this.sdpQueue=[]},q=async function(){let e=new RTCPeerConnection;return e.addTransceiver("audio"),e.addTransceiver("video"),(await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})).sdp},K=async function(){if(l(this,a,M).call(this))throw new Error("handshake only called once in a session");let e=new Promise((c,d)=>{this.syscallStream=this.openStream(g.SYSCALL_STREAM,{onmessage:l(this,a,G).bind(this),onopen:(p,k)=>c(k),onerror:(p,k)=>d(k)})}),s=l(this,a,v).call(this),t=[...this.sentTracks],{localOffer:i}=await l(this,a,D).call(this,t);console.log("local offer sdp",i.sdp),this.iceUsername=i.sdp.match(/a=ice-ufrag:(.*)[\r\n]+/)[1],this.icePassword=i.sdp.match(/a=ice-pwd:(.*)[\r\n]+/)[1];let n=await fetch(this.url,{method:"POST",body:JSON.stringify({sdp:i.sdp,cname:this.cname,capability:await l(this,a,q).call(this)}),headers:{"Content-Type":"application/json"}});if(!n.ok)throw new Error(`Request rejected with status ${n.status}`);let r;try{r=await n.text();let{sdp:c,mid_media_path_map:d}=JSON.parse(r);for(let p in d||{})this.midMediaPathMap[p]=d[p];console.log("midMediaPathMap =>",this.midMediaPathMap),this.id=c.match(/a=ice-ufrag:(.*)[\r\n]+/)[1],console.log("id",this.id),await l(this,a,b).call(this,c,s,t),await e,this.syscall_ready=!0,this.onopen&&(this.context=await this.onopen())}catch(c){throw console.log(`error in handling whip response: ${c}|${r||"no response"}`),c}},O=async function(e){if(!this.pc)return;e&&await this.syscall("close",{});let s;this.onclose?(s=this.onclose(),s?s=s/1e3/1e3:s=0):s=5e3;for(let t in this.tracks)console.log("close track",t),await this.tracks[t].close(this.pc,!0);for(let t in this.streams)console.log("close stream",t),this.streams[t].close();this.timer&&clearInterval(this.timer),this.pc.connectionState!="failed"&&this.pc.close(),this.pc=null,l(this,a,$).call(this),s>0?(console.log(`attempt reconnect after ${s} ms`),setTimeout(()=>{this.reconnect++,this.connect()},s)):console.log("no reconnect. bye!")},N=function(e){let s=e.split("/");if(s.length==1)return e+"/";if(s[s.length-1].length>0)throw new Error(`invalid path: ${e}: should be ended with /`);return e},H=function(e,s,t){let i=e.split("/"),n;return(i[i.length-1]==="video"||i[i.length-1]==="audio")&&(e=e.slice(0,-5)),this.medias[e]?n=this.medias[e]:(n=new R(e,s,t),this.medias[e]=n),n},X=function(e){let s=e.split("/");if(s.length<2)throw new Error(`invalid path: ${e}: at least \${cname}/\${single_component_local_path} required`);if(s.length==2){let t=s[s.length-1];if(t==="audio"||t==="video")throw new Error(`invalid path: ${e}: has single component local_path but the component seems to be media kind`);return{cpath:e+"/",kind:void 0}}else{let t=s[s.length-1];return t.length>0?t!=="audio"&&t!=="video"?{cpath:e+"/",kind:void 0}:{cpath:e,kind:t}:{cpath:e,kind:void 0}}},L=async function(e){let s={};for(let t of e){let i=this.tracks[t];i&&(s[i.media.path]=i.media,await i.close(this.pc),delete this.tracks[t]);let n=this.sentTracks.indexOf(i);n>=0&&this.sentTracks.splice(n,1)}for(let t in s){let i=s[t];Object.keys(i.tracks).length===0&&(console.log("close media",i.path),delete this.medias[i.path])}},j=function(e,s){let t=e.label;e.onopen=s.onopen&&(async i=>{s.publish&&await this.syscall("publish_stream",{path:t});let n=s.onopen(e,i);n&&typeof n=="object"&&"close"in n?(console.log(`close stream by application path=${t}`),this.closeStream(t)):e.context=n})||(async i=>{s.publish&&await this.syscall("publish_stream",{path:t})}),e.onclose=s.onclose&&(i=>{s.onclose(e,i),delete this.streams[t]})||(i=>{delete this.streams[t]}),e.onerror=s.onerror&&(i=>{s.onerror(e,i),delete this.streams[t]})||(i=>{delete this.streams[t]}),e.onmessage=i=>s.onmessage(e,i),this.streams[t]=e},o(g,"SYSCALL_STREAM","$syscall"),o(g,"DEFAULT_SCALABILITY_MODE","L1T3"),o(g,"NO_INPUT_THRESHOLD",3),o(g,"VERBOSE_SYSCALL",["ping","ping_ack"]),o(g,"MAX_MSGID",Number.MAX_SAFE_INTEGER);var _=g;return ne(oe);})();
//# sourceMappingURL=qrpc.bundle.js.map
