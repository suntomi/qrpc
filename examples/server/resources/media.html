<!doctype html>
<html>
  <head>
    <title>WebRTC with QRPC media</title>
  </head>
  <body>
    <div id="cname"></div>
    <div id="subscribe">
      <input type="text" id="idedit" placeholder="input connection id of other peer"/>
      <input type="text" id="label_sub" placeholder="input label name" value="webcam"/>
      <button id="sub">subscribe</button>
    </div>
    <div id="publish">
      <input type="text" id="label_pub" placeholder="input label name" value="webcam2"/>
      <button id="pub">publish</button>
    </div>
    <div>published tracks</div>
    <div id="pubsList"></div>
    <div>subscribed tracks</div>
    <div id="subsList"></div>

    <script src="http://localhost:8888/client.js"></script>
    <script>
      const pubsList = document.getElementById('pubsList');
      const subsList = document.getElementById('subsList');
      const pub = document.getElementById('pub');
      const sub = document.getElementById('sub');
      createMediaHandler = (dom) => {
        return {
          onopen: (track)=>{
            console.log("media open", track.stream.id, track.id);
            showMedia(track, dom);
          },
          onclose: (track)=>{
            console.log("media close", track.id, track.kind);
            document.getElementById(`${track.kind}-${track.id}`).remove();
          },
        };
      }
      showMedia = (t, dom) => {
        // console.log(`play ${t.kind}`, t.label);
        let mediaElement = document.getElementById(`${t.kind}-${t.id}`);
        if (!mediaElement) {
          mediaElement = document.createElement(t.kind);
          mediaElement.id = `${t.kind}-${t.id}`;
          mediaElement.autoplay = true;
          dom.appendChild(mediaElement);
        }
        mediaElement.srcObject = t.stream;
      }
      createMedia = async (path, handler) => {
        await c.createMedia(path, Object.assign({}, handler, {
          stream: await navigator.mediaDevices.getUserMedia({
            video: {width: {ideal: 1280}, height: {ideal: 720}},
            audio: true
          }), 
          encodings: [
            // 5Mbps ?
            {rid: 'h1', maxBitrate: 5000000, active: true, scaleResolutionDownBy: 1.0},
            // 1Mbps ?
            {rid: 'm1', maxBitrate: 1000000, active: true, scaleResolutionDownBy: 2.0},
            // 100kbps ?
            {rid: 'l1', maxBitrate: 500000, active: true, scaleResolutionDownBy: 4.0}
          ],
        }));        
      }
      onPublish = async (event) => {
        const path = document.getElementById('label_pub').value;
        console.log(`publish: input path = ${path}`);
        await createMedia(path, createMediaHandler(pubsList));
      }
      onSubscribe = async (event) => {
        const id = document.getElementById('idedit').value;
        const label = document.getElementById('label_sub').value;
        const path = `${id}/${label}`;
        console.log(`subscribe: input path = ${path}`);
        await c.openMedia(path, createMediaHandler(subsList));
      }
      setupUI = (c) => {
        // このconnectionのidを表示
        let idElement = document.getElementById("cname");
        if (idElement) {
          idElement.innerText = c.cname;
        }
        pub.addEventListener('click', onPublish);
        sub.addEventListener('click', onSubscribe);
      }
      cleanupUI = (c) => {
        pub.removeEventListener('click', onPublish);
        sub.removeEventListener('click', onSubscribe);
      }
      //Create whip client
      const url = "http://localhost:8888/qrpc";
      const c = new QRPClient(url);
      const context = {};
      const MAX_RECONNECT = 1;
      let closed = 0;
      c.onopen = async () => {
        console.log("client onopen called");
        setupUI(c);
        await createMedia("webcam", createMediaHandler(pubsList));
        return context;
      };
      c.onclose = () => {
        console.log("client onclose called", closed);
        cleanupUI(c);
        if (closed < MAX_RECONNECT) {
          closed++;
          return 2000 * 1000 * 1000;
        } else {
          return;
        }
      };
      c.connect();
    </script>
  </body>
</html>
