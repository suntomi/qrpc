<!doctype html>
<html>
  <head>
    <title>WebRTC with QRPC media</title>
  </head>
  <body>
    <script src="http://localhost:8888/client.js"></script>
    <script>
      showError = (err) => {
        showResult("error:" + err);
        throw new Error(err);
      }
      showResult = (result) => {
        let div = document.getElementById("result");
        if (!div) {
          div = document.createElement("div");
          div.id = "result";
          document.body.appendChild(div);
        }
        div.innerText = result;
      };
      showMedia = (m, t) => {
        if (t.kind == "video") {
          console.log("play video", m.label);
          let videoElement = document.getElementById(`video-${t.id}`);
          if (!videoElement) {
            videoElement = document.createElement('video');
            videoElement.id = `video-${t.id}`;
            videoElement.autoplay = true;
            document.body.appendChild(videoElement);
          }
          videoElement.srcObject = m.stream;
        } else if (t.kind == "audio") {
          console.log("play audio", m.label);
          let audioElement = document.getElementById(`audio-${t.id}`);
          if (!audioElement) {
            audioElement = document.createElement('audio');
            audioElement.id = `audio-${t.id}`;
            audioElement.autoplay = true;
            document.body.appendChild(audioElement);
          }
          audioElement.srcObject = m.stream;          
        }
      }
      //Create whip client
      const url = "http://localhost:8888/qrpc";
      const c = new QRPClient(url);
      const context = {};
      const MAX_RECONNECT = 0;
      let closed = 0;
      c.onopen = async () => {
        console.log("client onopen called");
        await c.openMedia("webcam", await navigator.mediaDevices.getUserMedia({ video: true, audio: true }), [
          // 1500kbps ?
          {rid: 'h1', maxBitrate: 1500000, active: true, priority: "high"},
          // 500kbps ?
          {rid: 'm1', maxBitrate: 500000, active: true, scaleResolutionDownBy: 2.0},
          // 100kbps ?
          {rid: 'l1', maxBitrate: 100000, active: true, scaleResolutionDownBy: 4.0}
        ]);
        console.log("open media");
        return context;
      };
      c.onclose = () => {
        console.log("client onclose called", closed);
        if (closed < MAX_RECONNECT) {
          closed++;
          return 2000 * 1000 * 1000;
        } else {
          // stop reconnection
          showResult("success");
          return;
        }
      };
      c.handleMedia("webcam", {
        onopen: (m, track)=>{
          console.log("media open", m.stream.id, track.id);
          showMedia(m, track);
        },
        onclose: (m)=>{
          console.log("media close", m.stream.id);
          document.getElementById(`video-${m.stream.id}`).remove();
        },
      });
      c.connect();
    </script>
  </body>
</html>
