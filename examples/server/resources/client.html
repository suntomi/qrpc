<!doctype html>
<html>
  <head>
    <title>WebRTC with QRPC base</title>
  </head>
  <body>
    <script src="http://localhost:8888/client.js"></script>
    <script>
      //Create whip client
      const url = "http://localhost:8888/accept";
      const c = new QRPClient(url);
      const context = { texts: ["aaaa", "bbbb", "cccc"] };
      const MAX_RECONNECT = 1;
      let closed = 0;
      c.onopen = () => {
        console.log("client onopen called");
        c.openStream("test");
      };
      c.onclose = () => {
        console.log("client onclose called", closed);
        if (closed <= MAX_RECONNECT) {
          closed++;
          return 2000 * 1000 * 1000;
        } else {
          // stop reconnection
          return;
        }
      };
      c.handler("test", {
        onopen: (s, event)=>{
          console.log("Data channel open", event);
          s.send(JSON.stringify({hello: context.texts[0], count: 0, ts: Date.now()}));
          return context;
        },
        onclose: (s, event)=>{
          console.log("Data channel close", event);
          c.openStream("test2");
        },
        onmessage: (s, event)=>{
          const now = Date.now();
          const resp = JSON.parse(event.data);
          console.log("Data channel message", resp);
          if (resp.hello != ("test:" + s.context.texts[resp.count])) {
            console.log("Data channel message hello wrong", resp.hello, "should be", s.context.texts[resp.count]);
            return;
          }
          if (resp.count < 2) {
            console.log("Data channel latency", now - resp.ts);
            s.send(JSON.stringify({hello: s.context.texts[resp.count + 1], count: resp.count + 1, ts: now}));
          } else {
            s.close();
          }
        }
      });
      c.handler("test2", {
        onopen: (s, event)=>{
          console.log("Data channel2 open", s.label, s.readyState);
          s.send(JSON.stringify({streamName: "recv"})); //will create stream which name is "recv"
          return false; // close stream
        },
        onmessage: (s, event)=>{
          throw new Error("should not be called");
        }
      });
      c.handler("recv", {
        onopen: (s, event)=>{
          console.log("Data channel3 open", s.label, closed, closed <= MAX_RECONNECT);
          // die is true, server close connection.
          s.send(JSON.stringify({die: closed <= MAX_RECONNECT}));
        },
        onmessage: (s, event)=>{
          const resp = JSON.parse(event.data);
          console.log("Data channel3 message", resp);
          c.close();
        }
      });

      c.connect();
    </script>
  </body>
</html>
